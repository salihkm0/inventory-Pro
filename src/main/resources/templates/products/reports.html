<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <title>Reports - InventoryPro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .sidebar {
        transition: all 0.3s ease;
      }
      .mobile-menu-overlay {
        display: none;
      }
      .nav-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0.75rem;
        color: #374151;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .nav-item:hover {
        background-color: #eff6ff;
        color: #2563eb;
      }
      .nav-item.active {
        background-color: #dbeafe;
        color: #2563eb;
      }
      .nav-icon {
        width: 1.5rem;
        text-align: center;
        margin-right: 0.75rem;
      }
      .nav-text {
        flex: 1;
        font-size: 0.875rem;
        font-weight: 500;
      }
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
        }
        .mobile-menu-overlay.active {
          display: block;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Include sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen flex flex-col">
      <!-- Top Header -->
      <header
        class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30"
      >
        <div class="px-6 py-4">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-xl font-semibold text-gray-800">
                Reports & Analytics
              </h2>
              <p class="text-gray-600 text-sm mt-1">
                Comprehensive insights into your inventory performance
              </p>
            </div>
            <div class="flex items-center space-x-4">
              <button
                onclick="window.print()"
                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center"
              >
                <i class="fas fa-print mr-2"></i>
                Print Report
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <main class="flex-1 p-6">
        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center">
              <div class="p-3 bg-blue-100 rounded-lg">
                <i class="fas fa-boxes text-blue-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total Products</p>
                <p
                  class="text-2xl font-bold text-gray-900"
                  th:text="${totalProductsReport}"
                >
                  0
                </p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center">
              <div class="p-3 bg-green-100 rounded-lg">
                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Inventory Value</p>
                <p
                  class="text-2xl font-bold text-gray-900"
                  th:text="'₹' + ${#numbers.formatDecimal(totalInventoryValueDouble, 1, 2)}"
                >
                  $0.00
                </p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center">
              <div class="p-3 bg-yellow-100 rounded-lg">
                <i
                  class="fas fa-exclamation-triangle text-yellow-600 text-xl"
                ></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Low Stock Items</p>
                <p
                  class="text-2xl font-bold text-gray-900"
                  th:text="${lowStockCount}"
                >
                  0
                </p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center">
              <div class="p-3 bg-red-100 rounded-lg">
                <i class="fas fa-times-circle text-red-600 text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Out of Stock</p>
                <p
                  class="text-2xl font-bold text-gray-900"
                  th:text="${outOfStockCount}"
                >
                  0
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Stock Status Chart -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Stock Status Distribution
            </h3>
            <div class="h-80">
              <canvas id="stockStatusChart"></canvas>
            </div>
          </div>

          <!-- Inventory Value Chart -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Inventory Value Overview
            </h3>
            <div class="h-80">
              <canvas id="inventoryValueChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Stock Status Details -->
        <div
          class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-8"
        >
          <h3 class="text-lg font-semibold text-gray-800 mb-4">
            Inventory Summary
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <div
                class="text-2xl font-bold text-green-600"
                th:text="${inStockCount}"
              >
                0
              </div>
              <p class="text-sm text-green-800">In Stock Products</p>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded-lg">
              <div
                class="text-2xl font-bold text-yellow-600"
                th:text="${lowStockCount}"
              >
                0
              </div>
              <p class="text-sm text-yellow-800">Low Stock Products</p>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg">
              <div
                class="text-2xl font-bold text-red-600"
                th:text="${outOfStockCount}"
              >
                0
              </div>
              <p class="text-sm text-red-800">Out of Stock Products</p>
            </div>
          </div>
        </div>

        <!-- Detailed Reports -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Top Products by Value Section -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Top Products by Inventory Value
            </h3>
            <div class="space-y-3">
              <div
                th:each="product, iter : ${topProductsByValue}"
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
              >
                <div class="flex items-center">
                  <div
                    class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3"
                  >
                    <span
                      class="text-blue-600 font-semibold text-sm"
                      th:text="${iter.index + 1}"
                    ></span>
                  </div>
                  <div>
                    <p
                      class="text-sm font-medium text-gray-900"
                      th:text="${product.name} ?: 'Unnamed Product'"
                    >
                      Product Name
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      th:text="${product.sku} ?: 'No SKU'"
                    >
                      SKU
                    </p>
                    <p class="text-xs text-gray-500">
                      Stock: <span th:text="${product.quantity}">0</span> |
                      Price: $<span
                        th:text="${#numbers.formatDecimal(product.price, 1, 2)}"
                        >0.00</span
                      >
                    </p>
                  </div>
                </div>
                <div class="text-right">
                  <span
                    class="text-sm font-semibold text-green-600 block"
                    th:text="'₹' + ${#numbers.formatDecimal(product.price.doubleValue() * product.quantity, 1, 2)}"
                    >$0.00</span
                  >
                  <span class="text-xs text-gray-500">Total Value</span>
                </div>
              </div>
              <div
                th:if="${topProductsByValue == null or topProductsByValue.empty}"
                class="text-center py-4"
              >
                <i class="fas fa-box-open text-gray-400 text-3xl mb-2"></i>
                <p class="text-gray-500">No product data available</p>
              </div>
            </div>
          </div>

          <!-- Low Stock Alerts Section -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Low Stock Alerts
            </h3>
            <div class="space-y-3">
              <div
                th:each="product : ${lowStockProductsList}"
                class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200"
              >
                <div class="flex items-center">
                  <div
                    class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center mr-3"
                  >
                    <i
                      class="fas fa-exclamation-triangle text-yellow-600 text-sm"
                    ></i>
                  </div>
                  <div>
                    <p
                      class="text-sm font-medium text-gray-900"
                      th:text="${product.name} ?: 'Unnamed Product'"
                    >
                      Product Name
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      th:text="${product.sku} ?: 'No SKU'"
                    >
                      SKU
                    </p>
                    <p class="text-xs text-gray-500">
                      Current Stock:
                      <span class="font-semibold" th:text="${product.quantity}"
                        >0</span
                      >
                      | Reorder Level:
                      <span
                        th:text="${product.reorderLevel != null ? product.reorderLevel : '10'}"
                        >10</span
                      >
                    </p>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-sm font-semibold text-yellow-600"
                    >Low Stock</span
                  >
                  <p
                    class="text-xs text-gray-500"
                    th:if="${product.reorderLevel != null and product.quantity <= product.reorderLevel}"
                  >
                    Below reorder level
                  </p>
                </div>
              </div>
              <div
                th:if="${lowStockProductsList == null or lowStockProductsList.empty}"
                class="text-center py-4"
              >
                <i class="fas fa-check-circle text-green-400 text-3xl mb-2"></i>
                <p class="text-gray-500">No low stock items - Great job!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">
            Export Reports
          </h3>
          <div class="flex flex-wrap gap-4">
            <a
              th:href="@{/export/reports/excel}"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center"
            >
              <i class="fas fa-file-excel mr-2"></i>
              Export to Excel
            </a>
            <a
              th:href="@{/export/products/excel}"
              class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center"
            >
              <i class="fas fa-boxes mr-2"></i>
              Export Products
            </a>
            <a
              th:href="@{/export/sales/excel}"
              class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center"
            >
              <i class="fas fa-shopping-cart mr-2"></i>
              Export Sales
            </a>
          </div>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          console.log('Reports page loaded - initializing charts');
          initializeCharts();
      });

      function initializeCharts() {
          console.log('Initializing charts with actual data...');

          // Stock Status Chart
          const stockStatusCtx = document.getElementById('stockStatusChart');
          if (stockStatusCtx) {
              try {
                  // Get data from Thymeleaf attributes
                  const inStockCount = [[${inStockCount}]] || 0;
                  const lowStockCount = [[${lowStockCount}]] || 0;
                  const outOfStockCount = [[${outOfStockCount}]] || 0;

                  console.log('Chart Data - In Stock:', inStockCount, 'Low Stock:', lowStockCount, 'Out of Stock:', outOfStockCount);

                  new Chart(stockStatusCtx, {
                      type: 'doughnut',
                      data: {
                          labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                          datasets: [{
                              data: [inStockCount, lowStockCount, outOfStockCount],
                              backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                              borderWidth: 2,
                              borderColor: '#FFFFFF'
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: {
                                  position: 'bottom'
                              },
                              tooltip: {
                                  callbacks: {
                                      label: function(context) {
                                          const label = context.label || '';
                                          const value = context.raw || 0;
                                          const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                          const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                          return `${label}: ${value} (${percentage}%)`;
                                      }
                                  }
                              }
                          }
                      }
                  });
                  console.log('Stock status chart created successfully');
              } catch (error) {
                  console.error('Error creating stock status chart:', error);
              }
          }

          // Inventory Value Chart
          const inventoryValueCtx = document.getElementById('inventoryValueChart');
          if (inventoryValueCtx) {
              try {
                  const totalValue = [[${totalInventoryValueDouble}]] || 0;
                  console.log('Inventory Value for chart:', totalValue);

                  new Chart(inventoryValueCtx, {
                      type: 'bar',
                      data: {
                          labels: ['Total Inventory Value'],
                          datasets: [{
                              label: 'Inventory Value ($)',
                              data: [totalValue],
                              backgroundColor: '#3B82F6',
                              borderColor: '#2563EB',
                              borderWidth: 1
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          scales: {
                              y: {
                                  beginAtZero: true,
                                  ticks: {
                                      callback: function(value) {
                                          return '₹' + value.toLocaleString();
                                      }
                                  }
                              }
                          },
                          plugins: {
                              legend: {
                                  display: false
                              },
                              tooltip: {
                                  callbacks: {
                                      label: function(context) {
                                          return 'Value: $' + context.raw.toLocaleString();
                                      }
                                  }
                              }
                          }
                      }
                  });
                  console.log('Inventory value chart created successfully');
              } catch (error) {
                  console.error('Error creating inventory value chart:', error);
              }
          }
      }
    </script>
  </body>
</html>
