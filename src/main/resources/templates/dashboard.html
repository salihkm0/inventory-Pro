<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="fragments/header :: head('Dashboard')">
    <!-- CSRF Meta Tags for Spring Security -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="bg-gray-50">
    <!-- Include sidebar -->
    <div th:replace="fragments/sidebar :: body"></div>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen flex flex-col">
        <!-- Top Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800">Dashboard</h2>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 p-6">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Products -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Products</p>
                            <p class="text-2xl font-bold text-gray-900" th:text="${totalProducts}">0</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-boxes text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-2 flex space-x-2 text-xs">
                        <span class="text-red-600" th:text="${lowStockProducts} + ' low stock'"></span>
                        <span class="text-gray-400">â€¢</span>
                        <span class="text-gray-600" th:text="${outOfStockProducts} + ' out of stock'"></span>
                    </div>
                </div>

                <!-- Inventory Value -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Inventory Value</p>
                            <p class="text-2xl font-bold text-gray-900" th:text="'$' + ${#numbers.formatDecimal(totalInventoryValue, 1, 2)}">$0.00</p>
                        </div>
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">Current stock value</div>
                </div>

                <!-- Today's Sales -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Today's Sales</p>
                            <p class="text-2xl font-bold text-gray-900" th:text="'$' + ${#numbers.formatDecimal(todaySales, 1, 2)}">$0.00</p>
                        </div>
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <i class="fas fa-shopping-cart text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">Revenue today</div>
                </div>

                <!-- Monthly Sales -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Monthly Sales</p>
                            <p class="text-2xl font-bold text-gray-900" th:text="'$' + ${#numbers.formatDecimal(monthlySales, 1, 2)}">$0.00</p>
                        </div>
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i class="fas fa-chart-line text-orange-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">This month</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Monthly Sales Chart -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Monthly Sales Trend</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 rounded" id="monthlyChartInfo" 
                                  th:classappend="${hasMonthlyData} ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                  th:text="${hasMonthlyData} ? 'Real Data (' + ${monthlySalesData.size()} + ' months)' : 'No Sales Data'">
                            </span>
                            <span class="text-xs text-gray-500" th:text="'Total Sales: ' + ${totalSalesCount}"></span>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                    <div id="monthlyChartPlaceholder" class="text-center py-8" th:classappend="${hasMonthlyData} ? 'hidden' : ''">
                        <i class="fas fa-chart-line text-gray-300 text-4xl mb-2"></i>
                        <p class="text-gray-500">No sales data available for charts</p>
                        <p class="text-sm text-gray-400 mb-4">Record some sales to see trends</p>
                        <button onclick="createSampleData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i> Create Sample Sales Data
                        </button>
                    </div>
                </div>

                <!-- Sales by Category Chart -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Sales by Category</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 rounded" id="categoryChartInfo"
                                  th:classappend="${hasCategoryData} ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                  th:text="${hasCategoryData} ? 'Real Data (' + ${salesByCategory.size()} + ' categories)' : 'No Category Data'">
                            </span>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="categorySalesChart"></canvas>
                    </div>
                    <div id="categoryChartPlaceholder" class="text-center py-8" th:classappend="${hasCategoryData} ? 'hidden' : ''">
                        <i class="fas fa-chart-pie text-gray-300 text-4xl mb-2"></i>
                        <p class="text-gray-500">No category sales data available</p>
                        <p class="text-sm text-gray-400">Sales will appear here when recorded</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a th:href="@{/products/new}" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors">
                        <i class="fas fa-plus text-2xl mb-2"></i>
                        <div class="font-medium">Add Product</div>
                    </a>
                    <a th:href="@{/sales/new}" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center transition-colors">
                        <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                        <div class="font-medium">Record Sale</div>
                    </a>
                    <a th:href="@{/products/low-stock}" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg text-center transition-colors">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div class="font-medium">Low Stock</div>
                    </a>
                    <a th:href="@{/products/reports}" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center transition-colors">
                        <i class="fas fa-chart-bar text-2xl mb-2"></i>
                        <div class="font-medium">View Reports</div>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        
        // Global variables to store chart data
        let monthlyChart = null;
        let categoryChart = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸŽ¯ Dashboard initialized, loading charts...');
            initializeCharts();
        });

        function initializeCharts() {
            console.log('ðŸ“Š Starting chart initialization...');
            
            // Try multiple methods to get chart data
            loadChartData()
                .then(data => {
                    console.log('âœ… Chart data loaded successfully:', data);
                    createCharts(data.monthlySales, data.salesByCategory);
                })
                .catch(error => {
                    console.error('âŒ Error loading chart data:', error);
                    // Fallback to Thymeleaf data
                    fallbackToThymeleafData();
                });
        }

        function loadChartData() {
            return new Promise((resolve, reject) => {
                // Method 1: Try API endpoint first
                fetch('/api/dashboard/charts')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API response not ok: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            resolve(data);
                        } else {
                            throw new Error('API returned error: ' + data.error);
                        }
                    })
                    .catch(apiError => {
                        console.log('ðŸ”„ API method failed, trying Thymeleaf data...');
                        // Method 2: Fallback to Thymeleaf data
                        const thymeleafData = getThymeleafData();
                        if (thymeleafData.success) {
                            resolve(thymeleafData);
                        } else {
                            reject(new Error('All data loading methods failed'));
                        }
                    });
            });
        }

        function getThymeleafData() {
            try {
                const monthlySalesData = /*[[${monthlySalesData}]]*/ {};
                const salesByCategory = /*[[${salesByCategory}]]*/ {};
                
                console.log('ðŸ” Thymeleaf Monthly Data:', monthlySalesData);
                console.log('ðŸ” Thymeleaf Category Data:', salesByCategory);
                
                if (Object.keys(monthlySalesData).length > 0 || Object.keys(salesByCategory).length > 0) {
                    return {
                        success: true,
                        monthlySales: monthlySalesData,
                        salesByCategory: salesByCategory
                    };
                } else {
                    return { success: false, error: 'No Thymeleaf data found' };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function fallbackToThymeleafData() {
            const data = getThymeleafData();
            if (data.success) {
                createCharts(data.monthlySales, data.salesByCategory);
            } else {
                console.log('ðŸ“ No chart data available, showing placeholders');
            }
        }

        function createCharts(monthlyData, categoryData) {
            destroyExistingCharts();
            createMonthlyChart(monthlyData);
            createCategoryChart(categoryData);
        }

        function destroyExistingCharts() {
            if (monthlyChart) {
                monthlyChart.destroy();
                monthlyChart = null;
            }
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
        }

        function createMonthlyChart(data) {
            const ctx = document.getElementById('monthlySalesChart');
            if (!ctx) {
                console.log('âŒ Monthly chart canvas not found');
                return;
            }

            if (!data || Object.keys(data).length === 0) {
                console.log('ðŸ“ No monthly data available');
                return;
            }

            try {
                const labels = Object.keys(data);
                const values = Object.values(data).map(val => Number(val) || 0);
                
                console.log('ðŸ“ˆ Creating monthly chart with:', { labels, values });
                
                monthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Sales ($)',
                            data: values,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Sales: $' + (context.raw || 0).toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… Monthly chart created successfully');
                document.getElementById('monthlyChartPlaceholder')?.classList.add('hidden');
                
            } catch (error) {
                console.error('âŒ Error creating monthly chart:', error);
            }
        }

        function createCategoryChart(data) {
            const ctx = document.getElementById('categorySalesChart');
            if (!ctx) {
                console.log('âŒ Category chart canvas not found');
                return;
            }

            if (!data || Object.keys(data).length === 0) {
                console.log('ðŸ“ No category data available');
                return;
            }

            try {
                const labels = Object.keys(data);
                const values = Object.values(data).map(val => Number(val) || 0);
                
                console.log('ðŸ“Š Creating category chart with:', { labels, values });
                
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)',
                                'rgb(139, 92, 246)', 'rgb(236, 72, 153)', 'rgb(99, 102, 241)'
                            ],
                            borderWidth: 2,
                            borderColor: 'white'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'right',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… Category chart created successfully');
                document.getElementById('categoryChartPlaceholder')?.classList.add('hidden');
                
            } catch (error) {
                console.error('âŒ Error creating category chart:', error);
            }
        }

        function refreshDashboard() {
            console.log('ðŸ”„ Refreshing dashboard...');
            location.reload();
        }

        function createSampleData() {
            if (confirm('This will create sample sales data for testing. Continue?')) {
                console.log('ðŸ“ Creating sample sales data...');
                
                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }
                
                fetch('/sales/create-sample', {
                    method: 'POST',
                    headers: headers
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                })
                .then(data => {
                    console.log('âœ… Sample data response:', data);
                    alert('Sample data created successfully! Refreshing page...');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                })
                .catch(error => {
                    console.error('âŒ Error creating sample data:', error);
                    alert('Error creating sample data: ' + error.message);
                });
            }
        }
        /*]]>*/
    </script>
</body>
</html>